<!DOCTYPE html><html lang="en"><head><title>plugins/state</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="plugins/state"><meta name="groc-project-path" content="src/plugins/state.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/plugins/state.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">extend = <span class="hljs-built_in">require</span> <span class="hljs-string">"extend"</span>
utils = <span class="hljs-built_in">require</span> <span class="hljs-string">"../core/utils.coffee"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p> triggered event functions</p></div></div><div class="code"><div class="wrapper">events =
  
  <span class="hljs-string">"state:init"</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    that = @
<span class="hljs-function">    
    <span class="hljs-title">done</span> = <span class="hljs-params">()</span> -&gt;</span>
      state.isReady = <span class="hljs-literal">true</span>
      that.events.trigger <span class="hljs-string">"state:ready"</span>
      
    state.initialized = <span class="hljs-literal">true</span>
    state.init.call(state, done)
    
  <span class="hljs-string">"step"</span>: <span class="hljs-function"><span class="hljs-params">(time)</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.step.call(state, time)
    
  <span class="hljs-string">"prerender"</span>: <span class="hljs-function"><span class="hljs-params">(time)</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.prerender.call(state, time)
    
  <span class="hljs-string">"render"</span>: <span class="hljs-function"><span class="hljs-params">(time)</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.render.call(state, time)

  <span class="hljs-string">"postrender"</span>: <span class="hljs-function"><span class="hljs-params">(time)</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.postrender.call(state, time)
    
  <span class="hljs-string">"state:ready"</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.ready.call(state)
    
  <span class="hljs-string">"state:enter"</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    <span class="hljs-property">@aghs</span>.settings state.config
    state.enter.call(state)
    
  <span class="hljs-string">"state:leave"</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.leave.call(state)
  
  <span class="hljs-string">"state:destroy"</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    state.destroy.call(state)
<span class="hljs-function">
<span class="hljs-title">State</span> = <span class="hljs-params">(aghs, options = {})</span> -&gt;</span>

  <span class="hljs-property">@name</span> = options.name
  config = {
    <span class="hljs-string">"fullscreen"</span>: options.fullscreen
    <span class="hljs-string">"width"</span>:      options.width
    <span class="hljs-string">"height"</span>:     options.height
    <span class="hljs-string">"frameskip"</span>:  options.frameskip
    <span class="hljs-string">"smoothing"</span>:  options.smoothing
    <span class="hljs-string">"scale"</span>:      options.scaling
  }
  extend(@, options)
  <span class="hljs-property">@initialized</span> = <span class="hljs-literal">false</span>
  <span class="hljs-property">@isReady</span> = <span class="hljs-literal">false</span>
  <span class="hljs-property">@config</span> = extend(config, aghs.config)
  
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add all trigger functions to the prototype</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">State</span>::init       = utils.noop
<span class="hljs-attribute">State</span>::ready      = utils.noop
<span class="hljs-attribute">State</span>::enter      = utils.noop
<span class="hljs-attribute">State</span>::leave      = utils.noop
<span class="hljs-attribute">State</span>::destroy    = utils.noop
<span class="hljs-attribute">State</span>::prerender  = utils.noop
<span class="hljs-attribute">State</span>::render     = utils.noop
<span class="hljs-attribute">State</span>::postrender = utils.noop
<span class="hljs-attribute">State</span>::step       = utils.noop</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>StateMachine
Keeps track of state within the aghs app</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-title">StateMachine</span> = <span class="hljs-params">(<span class="hljs-property">@aghs</span>)</span> -&gt;</span>
  <span class="hljs-property">@events</span> = <span class="hljs-property">@aghs</span>.events
  <span class="hljs-property">@states</span> = {}
  <span class="hljs-property">@length</span> = <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>bind all events</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@events</span>.<span class="hljs-literal">on</span> eventname, callback, @ <span class="hljs-keyword">for</span> eventname, callback <span class="hljs-keyword">of</span> events
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the state when first initialized</p></div></div><div class="code"><div class="wrapper">  emptyState = <span class="hljs-string">"empty"</span>
  <span class="hljs-property">@add</span>({<span class="hljs-attribute">name</span>: emptyState})
  <span class="hljs-property">@active</span> = emptyState
  
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>StateMachine.add()
Add a new state
param: {name, <any state event above as a function (ie, "step")>}</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">StateMachine</span>::add = <span class="hljs-function"><span class="hljs-params">(options = {})</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.name?
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"state 'name' is missing from options parameter."</span>
  
  state = <span class="hljs-keyword">new</span> State(<span class="hljs-property">@aghs</span>, options)
  <span class="hljs-property">@states</span>[state.name] = state
  <span class="hljs-property">@length</span> += <span class="hljs-number">1</span>
  
  <span class="hljs-property">@set</span>(name) <span class="hljs-keyword">if</span> length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> state
  

<span class="hljs-attribute">StateMachine</span>::set = <span class="hljs-function"><span class="hljs-params">(name)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@states</span>[name]?
    
    <span class="hljs-property">@events</span>.trigger <span class="hljs-string">"state:leave"</span>
    <span class="hljs-property">@active</span> = name
    state = <span class="hljs-property">@states</span>[<span class="hljs-property">@active</span>]
    
    <span class="hljs-keyword">if</span> state.initialized <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>
      <span class="hljs-property">@events</span>.trigger <span class="hljs-string">"state:init"</span>
    <span class="hljs-keyword">if</span> state.isReady
      <span class="hljs-property">@events</span>.trigger <span class="hljs-string">"state:ready"</span>
      <span class="hljs-property">@events</span>.trigger <span class="hljs-string">"state:enter"</span>
  <span class="hljs-keyword">return</span> @
  
  
<span class="hljs-attribute">StateMachine</span>::get = <span class="hljs-function"><span class="hljs-params">(name)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-property">@states</span>[name] <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>state.proxy()
proxy is the function attached to other objects,
if you would like a different usage model</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">StateMachine</span>::proxy = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>returns &quot;this&quot;, for usage such as:
aghs.state().get() or aghs.state().set(&quot;loading&quot;)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> @ <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
  
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> arguments[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">"string"</span>
    <span class="hljs-property">@set</span>(arguments[<span class="hljs-number">0</span>]) 
    <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>assume all other cases are state creations</p></div></div><div class="code"><div class="wrapper">  
  <span class="hljs-keyword">return</span> <span class="hljs-property">@add</span>(arguments[<span class="hljs-number">0</span>])


<span class="hljs-built_in">module</span>.exports = StateMachine</div></div></div></div></body></html>