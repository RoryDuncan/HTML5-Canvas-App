<!DOCTYPE html><html lang="en"><head><title>src/plugins/world</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/plugins/world"><meta name="groc-project-path" content="src/plugins/world.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/plugins/world.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">utils = <span class="hljs-built_in">require</span> <span class="hljs-string">"../core/utils.coffee"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="helpers">Helpers</h3>
<p>location
calculates the relative location</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-title">location</span> = <span class="hljs-params">(world, _x, _y)</span> -&gt;</span>
  
  offset = world.offset
  origin = world.origin
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>normalized</p></div></div><div class="code"><div class="wrapper">  
  x =  origin.x + offset.x + _x
  y =  origin.y + offset.y + _y
      
  <span class="hljs-keyword">return</span> [x, y]</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World Object
An object to execute CanvasRenderingContext2D methods relative to a coordinate system.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-title">World</span> = <span class="hljs-params">(<span class="hljs-property">@aghs</span> = <span class="hljs-literal">null</span>, options = {})</span> -&gt;</span>

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TypeError <span class="hljs-string">"Missing Agh.js Instance as first parameter."</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@aghs</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>operate on the primary context, not other layers</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@_</span> = <span class="hljs-property">@aghs</span>._
  
  <span class="hljs-property">@orientation</span> = 
    <span class="hljs-attribute">x</span>: <span class="hljs-number">1</span>
    <span class="hljs-attribute">y</span>: <span class="hljs-number">1</span>
  
  <span class="hljs-property">@origin</span> = 
    <span class="hljs-attribute">x</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">y</span>: <span class="hljs-number">0</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the &#39;camera&#39;, determining what is viewed on the canvas</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@view</span> = 
    <span class="hljs-attribute">x</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">y</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">z</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000</span>
    <span class="hljs-attribute">width</span>: options.width <span class="hljs-keyword">or</span> <span class="hljs-property">@aghs</span>.width
    <span class="hljs-attribute">height</span>: options.height <span class="hljs-keyword">or</span> <span class="hljs-property">@aghs</span>.height
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>offsets are added to each x and y calculation</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@offset</span> = 
    <span class="hljs-attribute">x</span>: <span class="hljs-number">0</span>
    <span class="hljs-attribute">y</span>: <span class="hljs-number">0</span>
  
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.viewport()
Set the viewport size</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::viewport = <span class="hljs-function"><span class="hljs-params">(w, h)</span>  -&gt;</span>
  <span class="hljs-keyword">return</span> @ <span class="hljs-keyword">unless</span> w
  h = w <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> h
  
  <span class="hljs-property">@view</span>.width = w
  <span class="hljs-property">@view</span>.height = h
  <span class="hljs-property">@aghs</span>.resize(w, h)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.inView()
Check if the coordinates are within the current view</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::inView = <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
  [x, y] = <span class="hljs-property">@calc</span>(x, y)
  xCheck = <span class="hljs-property">@view</span>.x &lt; x &lt; <span class="hljs-property">@view</span>.x + <span class="hljs-property">@view</span>.width
  yCheck = <span class="hljs-property">@view</span>.y &lt; y &lt; <span class="hljs-property">@view</span>.y + <span class="hljs-property">@view</span>.height
  <span class="hljs-keyword">return</span> xCheck <span class="hljs-keyword">and</span> yCheck</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.type()
Set the world to a specific preset, determining the origin and orientation</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::type = <span class="hljs-function"><span class="hljs-params">(preset)</span> -&gt;</span>
  
  <span class="hljs-property">@type</span> = preset <span class="hljs-keyword">or</span> <span class="hljs-property">@type</span>
  
  <span class="hljs-keyword">if</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"platformer"</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"chart"</span>
    <span class="hljs-property">@origin</span>.x = <span class="hljs-number">0</span>
    <span class="hljs-property">@origin</span>.y = <span class="hljs-property">@aghs</span>.canvas.height
  
  <span class="hljs-keyword">if</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"cartesian"</span> <span class="hljs-keyword">or</span> <span class="hljs-property">@type</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"map"</span>
    <span class="hljs-property">@origin</span>.x = <span class="hljs-property">@aghs</span>.canvas.width * <span class="hljs-number">0.5</span>
    <span class="hljs-property">@origin</span>.y = <span class="hljs-property">@aghs</span>.canvas.height * <span class="hljs-number">0.5</span>
    
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.clean()
Keeps our world grid decimal-free by making sure all numbers are integers</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::clean = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@view</span>.x = ~~(<span class="hljs-property">@view</span>.x)
  <span class="hljs-property">@view</span>.y = ~~(<span class="hljs-property">@view</span>.y)
  <span class="hljs-property">@offset</span>.x = ~~(<span class="hljs-property">@offset</span>.x)
  <span class="hljs-property">@offset</span>.y = ~~(<span class="hljs-property">@offset</span>.y)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.move()
Moves the viewport and offset by the x and y parameter amount</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::move = <span class="hljs-function"><span class="hljs-params">(x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>)</span> -&gt;</span>
  <span class="hljs-property">@view</span>.x   += x * <span class="hljs-property">@orientation</span>.x
  <span class="hljs-property">@view</span>.y   += y * <span class="hljs-property">@orientation</span>.y
  <span class="hljs-property">@offset</span>.x -= x * <span class="hljs-property">@orientation</span>.x
  <span class="hljs-property">@offset</span>.y -= y * <span class="hljs-property">@orientation</span>.y
  <span class="hljs-property">@clean</span>()
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.calc()
curried version of the location function</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::calc = <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span> <span class="hljs-keyword">return</span> location(@, x, y)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.set()
Sets the world coordinates to a specific location</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::set = <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
  
  <span class="hljs-keyword">if</span> x?
    <span class="hljs-property">@offset</span>.x = <span class="hljs-property">@origin</span>.x - x
    <span class="hljs-property">@view</span>.x = <span class="hljs-property">@origin</span>.x + x
  
  <span class="hljs-keyword">if</span> y?
    <span class="hljs-property">@offset</span>.y = <span class="hljs-property">@origin</span>.y - y
    <span class="hljs-property">@view</span>.y = <span class="hljs-property">@origin</span>.y + y
    
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>World.debug()
show relevant information rendered onto the canvas.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::debug = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  size = <span class="hljs-number">12</span>
  <span class="hljs-property">@aghs</span>.fillStyle <span class="hljs-string">"#000"</span>
  .font(<span class="hljs-string">"<span class="hljs-subst">#{size}</span>px Small Fonts"</span>)
  .fillText(<span class="hljs-string">"view: x: <span class="hljs-subst">#{<span class="hljs-property">@view</span>.x}</span>, y: <span class="hljs-subst">#{<span class="hljs-property">@view</span>.y}</span> w: <span class="hljs-subst">#{<span class="hljs-property">@view</span>.width}</span> h: <span class="hljs-subst">#{<span class="hljs-property">@view</span>.height}</span>"</span>, size, <span class="hljs-property">@view</span>.height - size*<span class="hljs-number">2</span>)
  .fillText(<span class="hljs-string">"offset: <span class="hljs-subst">#{<span class="hljs-property">@offset</span>.x}</span>, <span class="hljs-subst">#{<span class="hljs-property">@offset</span>.y}</span>"</span>, size, <span class="hljs-property">@view</span>.height - size)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>  Canvas API</p>
<p>Methods that operate on the HTMLCanvasRendering Context</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this, ctx.translate(x, y);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::translate = <span class="hljs-function"><span class="hljs-params">(x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>)</span> -&gt;</span>
  <span class="hljs-property">@_</span>.translate.apply(<span class="hljs-property">@_</span>, <span class="hljs-property">@calc</span>(x, y))
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this, ctx.fillRect(x, y, width, height);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::fillRect = <span class="hljs-function"><span class="hljs-params">(x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>, w, h)</span> -&gt;</span>
  [calcX, calcY] = <span class="hljs-property">@calc</span> x, y
  <span class="hljs-property">@aghs</span>.fillRect(calcX, calcY, w, h)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.strokeRect(x, y, width, height);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::strokeRect = <span class="hljs-function"><span class="hljs-params">(x, y, w, h)</span> -&gt;</span> 
  [calcX, calcY] = <span class="hljs-property">@calc</span> x, y
  <span class="hljs-property">@aghs</span>.strokeRect(calcX, calcY, w, h)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.moveTo(x, y);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::moveTo = <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span> 
  [calcX, calcY] = <span class="hljs-property">@calc</span> x, y
  <span class="hljs-property">@_</span>.moveTo.apply(<span class="hljs-property">@_</span>, <span class="hljs-property">@calc</span>(x, y))
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.lineTo(x, y);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::lineTo = <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
  [calcX, calcY] = <span class="hljs-property">@calc</span> x, y
  <span class="hljs-property">@_</span>.lineTo.apply(<span class="hljs-property">@_</span>, <span class="hljs-property">@calc</span>(x, y))
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.quadraticCurveTo(cpx, cpy, x, y);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::quadraticCurveTo = <span class="hljs-function"><span class="hljs-params">(cpx, cpy, x, y)</span> -&gt;</span>
  [_cpx, _cpy] = <span class="hljs-property">@calc</span>(cpx, cpy)
  [_x, _y] = <span class="hljs-property">@calc</span>(x, y)
  <span class="hljs-property">@_</span>.quadraticCurveTo(_cpx, _cpy, _x, _y)
  <span class="hljs-keyword">return</span> @
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x, y);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::bezierCurveTo = <span class="hljs-function"><span class="hljs-params">(cp1x, cp1y, cp2x, cp2y, x, y)</span> -&gt;</span> 
  [_cp1x, _cp1y] = <span class="hljs-property">@calc</span>(cp1x, cp1y)
  [_cp2x, _cp2y] = <span class="hljs-property">@calc</span>(cp2x, cp2y)
  [_x, _y] = <span class="hljs-property">@calc</span>(x, y)
  <span class="hljs-property">@_</span>.bezierCurveTo(_cp1x, _cp1y, _cp2x, _cp2y, _x, _y)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.arcTo(x1, y1, x2, y2, radius);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::arcTo = <span class="hljs-function"><span class="hljs-params">(x1, y1, x2, y2, radius)</span> -&gt;</span>
  [startx, starty] = <span class="hljs-property">@calc</span>(x1, y1)
  [endx, endy] = <span class="hljs-property">@calc</span>(x2, y2)
  <span class="hljs-property">@_</span>.arcTo(startx, starty, endx, endy, radius)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.rect(x, y, width, height);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::rect = <span class="hljs-function"><span class="hljs-params">(x, y, width, height)</span> -&gt;</span>
  [_x, _y] = <span class="hljs-property">@calc</span>(x,y)
  <span class="hljs-property">@_</span>.rect(_x, _y, width, height)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.arc(x, y, radius, startAngle, endAngle, anticlockwise);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::arc = <span class="hljs-function"><span class="hljs-params">(x, y, radius, startAngle, endAngle, anticlockwise)</span> -&gt;</span>
  [_x, _y] = <span class="hljs-property">@calc</span>(x, y);
  <span class="hljs-property">@_</span>.arc(_x, _y, radius, startAngle, endAngle, anticlockwise)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.ellipse(x, y, radiusX, radiusY, rotation, startAngle, endAngle, anticlockwise);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::ellipse = <span class="hljs-function"><span class="hljs-params">(x, y, radiusX, radiusY, rotation, startAngle, endAngle, anticlockwise)</span> -&gt;</span>
  [_x, _y] = <span class="hljs-property">@calc</span>(x, y)
  <span class="hljs-property">@_</span>.ellipse(_x, _y, radiusX, radiusY, rotation, startAngle, endAngle, anticlockwise)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ImageData ctx.getImageData(sx, sy, sw, sh);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::getImageData = <span class="hljs-function"><span class="hljs-params">(sx, sy, sw, sh)</span> -&gt;</span>
  [x, y] = <span class="hljs-property">@calc</span>(sx, sy)
  <span class="hljs-property">@_</span>.getImageData(x, y, sw, sh)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.putImageData(imagedata, dx, dy);
void ctx.putImageData(imagedata, dx, dy, dirtyX, dirtyY, dirtyWidth, dirtyHeight);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::putImageData = <span class="hljs-function"><span class="hljs-params">(imgdata, dx, dy, dirtyX, dirtyY, dirtyWidth, dirtyHeight)</span> -&gt;</span>
  [x, y] = <span class="hljs-property">@calc</span>(dx, dy)
  <span class="hljs-property">@_</span>.putImageData(imgdata, x, y, dirtyX, dirtyY, dirtyWidth, dirtyHeight)
  <span class="hljs-keyword">return</span> @</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>void ctx.drawImage(image, dx, dy);
void ctx.drawImage(image, dx, dy, dWidth, dHeight);
void ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-attribute">World</span>::drawImage = <span class="hljs-function"><span class="hljs-params">(image)</span> -&gt;</span>
  
  <span class="hljs-keyword">if</span> arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">9</span>
    [x, y] = <span class="hljs-property">@calc</span>(arguments[<span class="hljs-number">5</span>], arguments[<span class="hljs-number">6</span>])
    arguments[<span class="hljs-number">5</span>] = x
    arguments[<span class="hljs-number">6</span>] = y
    <span class="hljs-property">@_</span>.drawImage.apply(<span class="hljs-property">@_</span>, arguments)
  
  <span class="hljs-keyword">else</span>
    
    [dx, dy] = <span class="hljs-property">@calc</span>(arguments[<span class="hljs-number">1</span>], arguments[<span class="hljs-number">2</span>])
    dw = arguments[<span class="hljs-number">3</span>]
    dh = arguments[<span class="hljs-number">4</span>]
    <span class="hljs-property">@_</span>.drawImage(image, dx, dy, dw, dh)
    
  <span class="hljs-keyword">return</span> @

<span class="hljs-built_in">module</span>.exports = World
  </div></div></div></div></body></html>